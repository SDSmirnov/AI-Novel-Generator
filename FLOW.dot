digraph NovelGenerator {
    // Основные настройки: Вертикальный поток для списков
    rankdir=TB;
    newrank=true; // Важно для выравнивания кластеров
    //splines=ortho; // Ломаные линии для аккуратности
    
    // Стили узлов
    node [shape=box, style="rounded,filled", fontname="Arial", fillcolor="#ffffff", penwidth=1.5];
    edge [fontname="Helvetica", fontsize=10];

    // --- Узлы управления процессом ---
    //start [shape=circle, label="START", fillcolor="#4caf50", fontcolor="white", width=0.8];
    //end [shape=doublecircle, label="END", fillcolor="#f44336", fontcolor="white", width=0.8];

    // --- Кластер 1: Foundation (Библия Мира) ---
    subgraph cluster_foundation {
        fontname = "Arial";
        label = "Фаза 1: Foundation\n(Создание Библии Мира)";
        style = "filled,rounded";
        color = "#e3f2fd"; // Голубой фон
        fontcolor = "#1565c0";
        
        // Узлы идут вертикально, так как rankdir=TB
        f1_1 [label="1.1 Анализ\n[Архитектор-Планировщик]"];
        f1_2 [label="1.2 Персонажи\n[Архитектор]"];
        f1_3 [label="1.3 Мир\n[Демиург Сеттингов]"];
        f1_4 [label="1.4 Речевые профили\n[Литературный диалогист]"];
        f1_5 [label="1.5 Стиль книги\n[Литературный стилист]"];
        f1_6 [label="1.6 Стиль и тон\n[Литературный стилист]"];
        f1_7 [label="1.7 План сюжета\n[Опытный писатель]"];
        f1_8 [label="1.8 Критика плана\n[Сюжетный Доктор]"];
        f1_9 [label="1.9 Правка плана\n[Шоураннер]"];
        f1_10 [label="1.10 Модель мира\n[Системная сборка]"];

        // Связи внутри кластера (сверху вниз)
        f1_1 -> f1_2 -> f1_3 -> f1_4 -> f1_5 -> f1_6 -> f1_7 -> f1_8 -> f1_9 -> f1_10;
        
        // Петля переделки плана
        f1_9 -> f1_8 [label="Итерация (2x)", style=dashed]; //,  constraint=false];
    }

    // --- Кластер 2: Chapter Loop (Генерация Глав) ---
    subgraph cluster_chapter {
        label = "Фаза 2: Chapter Loop\n(Генерация Главы)";
        style = "filled,rounded";
        color = "#e8f5e9"; // Зеленоватый фон
        fontcolor = "#2e7d32";
        fontname = "Arial";

        c2_1 [label="2.1 План главы\n[Опытный писатель]"];
        c2_2 [label="2.2 Критика плана\n[Редактор-Придира]"];
        c2_3 [label="2.3 Правка плана\n[Сценарист]"];
        c3_1 [label="3.1 Черновик (Draft)\n[Мастер Слова]"];
        c4_1 [label="4.1 Критика (Сюжет)\n[Зануда]"];
        c4_3 [label="4.3 Редактура\n[Редактор-корректор]"];
        c4_4 [label="4.4 Контроль повторов\n[Qdrant + Редактор]"];
        c4_5 [label="4.5 Критика (Стиль)\n[Читатель]"];
        c5_0 [label="5.0 Финализация\n[Стилист]"];
        c6_0 [label="6.0 JSON State\n[Аналитик Состояния]"];
        
        check_next [shape=diamond, label="Есть главы?", style="filled", fillcolor="#fff9c4"];

        // Связи внутри кластера (сверху вниз)
        c2_1 -> c2_2 -> c2_3 -> c3_1 -> c4_1 -> c4_3 -> c4_4 -> c4_5 -> c5_0 -> c6_0 -> check_next;
    }

    // --- Глобальное выравнивание (Трюк для LR расположения кластеров) ---
    // Мы заставляем верхние узлы обоих кластеров быть на одном уровне.
    // Это располагает кластеры бок о бок.
    // { rank=same; start; f1_1; c2_1; }

    // --- Связи между этапами ---
    
    // Старт -> Начало фазы 1
    // start -> f1_1 [penwidth=2];

    // Конец фазы 1 -> Начало фазы 2
    // constraint=false позволяет нарисовать длинную стрелку снизу вверх
    // без нарушения вертикальной иерархии внутри кластеров
    

    // Цикл глав (Следующая глава)
    // Стрелка возвращается наверх кластера
    check_next -> c2_1 [label="Да\n(Update State)", color="#2e7d32", constraint=false];

    // Выход
    check_next -> end [label="Нет\n(Финиш)"];
    //f1_10 -> c2_1 [label="Передача\nWorld Bible", color="#1565c0", penwidth=2, constraint=false];
}
